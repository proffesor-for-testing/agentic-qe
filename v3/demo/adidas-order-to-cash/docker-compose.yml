##
## Adidas Order-to-Cash — 8 Mock Services + Optional RabbitMQ
##
## Usage:
##   docker compose up -d                           # In-memory broker (default)
##   docker compose --profile rabbitmq up -d        # With real RabbitMQ
##
##   docker compose stop sap-s4        # Kill SAP to trigger failure
##   docker compose restart sap-s4     # Recover SAP
##   docker compose down               # Stop everything
##
## Broker modes:
##   memory   — In-memory pub/sub (default, zero dependencies)
##   rabbitmq — Real RabbitMQ via AMQP (requires --profile rabbitmq)
##
## New services:
##   message-broker (3008) — Dual-mode pub/sub with DLQ
##   rabbitmq (5672/15672) — Optional real RabbitMQ (profile: rabbitmq)
##
## New endpoints:
##   GET  :3002/api/wsdl           — WSDL definition
##   POST :3002/api/soap/validate  — SOAP order validation
##   POST :3005/wms/idoc/generate  — Generate WMMBID01 IDoc
##   POST :3006/sap/idoc/inbound   — SAP IDoc inbound processing
##   POST :3008/broker/publish     — Publish message to topic
##   GET  :3008/broker/dlq         — Dead letter queue contents
##   GET  :3008/broker/mode        — Check active broker mode
##

services:

  # ── Optional: Real RabbitMQ (activate with --profile rabbitmq) ────────
  rabbitmq:
    image: rabbitmq:3-management
    profiles: [rabbitmq]
    ports:
      - "5672:5672"     # AMQP
      - "15672:15672"   # Management UI (guest/guest)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s
    restart: unless-stopped

  # ── Message Broker (port 3008) ────────────────────────────────────────
  message-broker:
    build: .
    environment:
      SERVICE_FILE: message-broker.ts
      BROKER_MODE: ${BROKER_MODE:-memory}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://rabbitmq:5672}
    ports:
      - "3008:3008"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3008/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  integrator-web:
    build: .
    environment:
      SERVICE_FILE: integrator-web.ts
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    depends_on:
      api-tester:
        condition: service_healthy
    restart: unless-stopped

  api-tester:
    build: .
    environment:
      SERVICE_FILE: api-tester.ts
    ports:
      - "3002:3002"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3002/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    depends_on:
      omni:
        condition: service_healthy
    restart: unless-stopped

  omni:
    build: .
    environment:
      SERVICE_FILE: omni.ts
    ports:
      - "3003:3003"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3003/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    depends_on:
      iib-esb:
        condition: service_healthy
      wms:
        condition: service_healthy
      sap-s4:
        condition: service_healthy
      kibana:
        condition: service_healthy
      message-broker:
        condition: service_healthy
    restart: unless-stopped

  iib-esb:
    build: .
    environment:
      SERVICE_FILE: iib-esb.ts
    ports:
      - "3004:3004"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3004/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  wms:
    build: .
    environment:
      SERVICE_FILE: wms.ts
    ports:
      - "3005:3005"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3005/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  sap-s4:
    build: .
    environment:
      SERVICE_FILE: sap-s4.ts
    ports:
      - "3006:3006"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3006/sap/bc/ping"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  kibana:
    build: .
    environment:
      SERVICE_FILE: kibana.ts
    ports:
      - "3007:3007"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3007/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
