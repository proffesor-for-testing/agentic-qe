<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kibana Dashboard â€” Adidas Order Analytics</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #1a1a2e; color: #e0e0e0; }
    header { background: #16213e; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3460; }
    header h1 { font-size: 20px; font-weight: 700; color: #00d4ff; }
    header .status { font-size: 13px; color: #7f8c8d; }
    main { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .card { background: #16213e; border-radius: 8px; padding: 20px; border: 1px solid #0f3460; }
    .card h3 { font-size: 14px; color: #7f8c8d; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .card .value { font-size: 32px; font-weight: 700; color: #00d4ff; }
    .systems-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 24px; }
    .system-card { background: #16213e; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #0f3460; }
    .system-card .name { font-size: 11px; color: #7f8c8d; margin-bottom: 4px; text-transform: uppercase; }
    .system-card .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-bottom: 4px; }
    .system-card .dot.ok { background: #28a745; box-shadow: 0 0 8px rgba(40,167,69,0.5); }
    .system-card .dot.down { background: #dc3545; box-shadow: 0 0 8px rgba(220,53,69,0.5); }
    .system-card .dot.unknown { background: #6c757d; }
    .system-card .latency { font-size: 10px; color: #7f8c8d; }
    .table-card { background: #16213e; border-radius: 8px; padding: 20px; border: 1px solid #0f3460; }
    .table-card h3 { font-size: 14px; color: #7f8c8d; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 8px; font-size: 12px; color: #7f8c8d; border-bottom: 1px solid #0f3460; text-transform: uppercase; }
    td { padding: 8px; font-size: 13px; border-bottom: 1px solid rgba(15,52,96,0.5); }
    .status-completed { color: #28a745; font-weight: 600; }
    .status-failed { color: #dc3545; font-weight: 600; }
    .bar-chart { display: flex; align-items: flex-end; gap: 4px; height: 120px; margin-top: 8px; }
    .bar { background: #00d4ff; border-radius: 2px 2px 0 0; min-width: 24px; transition: height 0.3s; cursor: pointer; position: relative; }
    .bar:hover { background: #00b8d4; }
    .bar .tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
    .bar:hover .tooltip { display: block; }
    .refresh-indicator { font-size: 11px; color: #7f8c8d; text-align: right; margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>KIBANA - Order Analytics</h1>
    <div class="status" id="connection-status">Connecting...</div>
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <h3>Total Orders</h3>
        <div class="value" id="total-orders">0</div>
      </div>
      <div class="card">
        <h3>Revenue</h3>
        <div class="value" id="total-revenue">&euro;0</div>
      </div>
      <div class="card">
        <h3>Success Rate</h3>
        <div class="value" id="success-rate">--</div>
      </div>
    </div>

    <h3 style="color: #7f8c8d; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">System Health</h3>
    <div class="systems-grid" id="systems-grid">
      <div class="system-card"><div class="dot unknown"></div><div class="name">Integrator</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">API Tester</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">OMNI</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">IIB ESB</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">WMS</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">SAP S/4</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">Kibana</div><div class="latency">--</div></div>
      <div class="system-card"><div class="dot unknown"></div><div class="name">Broker</div><div class="latency">--</div></div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 2fr;">
      <div class="card">
        <h3>Order Volume (Last 10)</h3>
        <div class="bar-chart" id="bar-chart"></div>
      </div>
      <div class="table-card">
        <h3>Recent Orders</h3>
        <table>
          <thead><tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
          <tbody id="orders-table"></tbody>
        </table>
      </div>
    </div>

    <div class="refresh-indicator" id="refresh-indicator">Last refresh: --</div>
  </main>

  <script>
    const SERVICES = [
      { name: 'Integrator', port: 3001 },
      { name: 'API Tester', port: 3002 },
      { name: 'OMNI', port: 3003 },
      { name: 'IIB ESB', port: 3004 },
      { name: 'WMS', port: 3005 },
      { name: 'SAP S/4', port: 3006 },
      { name: 'Kibana', port: 3007 },
      { name: 'Broker', port: 3008 },
    ];

    async function checkHealth(port) {
      const start = Date.now();
      try {
        const res = await fetch(`http://localhost:${port}/health`, { signal: AbortSignal.timeout(2000) });
        const latency = Date.now() - start;
        return { ok: res.ok, latency };
      } catch {
        return { ok: false, latency: -1 };
      }
    }

    async function fetchOrders() {
      try {
        const res = await fetch('/kibana/api/orders', { signal: AbortSignal.timeout(3000) });
        return await res.json();
      } catch {
        return { total: 0, orders: [] };
      }
    }

    async function refresh() {
      // Health checks
      const grid = document.getElementById('systems-grid');
      const results = await Promise.all(SERVICES.map(s => checkHealth(s.port)));

      grid.innerHTML = SERVICES.map((s, i) => {
        const r = results[i];
        const dotClass = r.ok ? 'ok' : 'down';
        const latencyText = r.ok ? `${r.latency}ms` : 'DOWN';
        return `<div class="system-card"><div class="dot ${dotClass}"></div><div class="name">${s.name}</div><div class="latency">${latencyText}</div></div>`;
      }).join('');

      // Orders
      const data = await fetchOrders();
      const orders = data.orders || [];

      document.getElementById('total-orders').textContent = orders.length;

      const completedOrders = orders.filter(o => o.status === 'COMPLETED');
      const revenue = completedOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('total-revenue').textContent = `\u20AC${revenue.toFixed(0)}`;

      const completed = orders.filter(o => o.status === 'COMPLETED').length;
      const rate = orders.length > 0 ? ((completed / orders.length) * 100).toFixed(0) : '--';
      document.getElementById('success-rate').textContent = orders.length > 0 ? `${rate}%` : '--';

      // Bar chart (last 10)
      const last10 = orders.slice(-10);
      const maxAmount = Math.max(...last10.map(o => o.totalAmount || 0), 1);
      const chart = document.getElementById('bar-chart');
      chart.innerHTML = last10.map(o => {
        const h = Math.max(((o.totalAmount || 0) / maxAmount) * 100, 4);
        const color = o.status === 'FAILED' ? '#dc3545' : '#00d4ff';
        return `<div class="bar" style="height:${h}px; flex:1; background:${color};"><span class="tooltip">${o.orderId}: \u20AC${(o.totalAmount||0).toFixed(0)} (${o.status})</span></div>`;
      }).join('');

      // Table
      const tbody = document.getElementById('orders-table');
      const recent = orders.slice(-10).reverse();
      tbody.innerHTML = recent.map(o => {
        const statusClass = o.status === 'COMPLETED' ? 'status-completed' : 'status-failed';
        const time = o.timestamp ? new Date(o.timestamp).toLocaleTimeString() : '--';
        return `<tr><td>${o.orderId || '--'}</td><td>${o.customer || '--'}</td><td>\u20AC${(o.totalAmount||0).toFixed(2)}</td><td class="${statusClass}">${o.status || '--'}</td><td>${time}</td></tr>`;
      }).join('');

      // Status
      document.getElementById('connection-status').textContent = `Connected - ${orders.length} events`;
      document.getElementById('refresh-indicator').textContent = `Last refresh: ${new Date().toLocaleTimeString()}`;
    }

    // Initial fetch + auto-refresh every 2s
    refresh();
    setInterval(refresh, 2000);
  </script>
</body>
</html>
