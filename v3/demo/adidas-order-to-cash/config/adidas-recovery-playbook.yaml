##
## Adidas Order-to-Cash Recovery Playbook
## Used by InfraHealingOrchestrator (ADR-057) to auto-recover failed services.
##
## Each service defines:
##   healthCheck  — command to detect if the service is alive
##   recover      — ordered commands to restart the service
##   verify       — command to confirm recovery succeeded
##   backoffMs    — exponential backoff between retries
##

version: "1.0.0"
defaults:
  timeoutMs: 5000
  maxRetries: 2
  backoffMs: [2000, 5000]

services:
  integrator-web:
    description: "Integrator Web — Storefront (port 3001)"
    healthCheck:
      command: "curl -sf http://localhost:3001/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart integrator-web"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3001/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  api-tester:
    description: "API Tester — REST gateway (port 3002)"
    healthCheck:
      command: "curl -sf http://localhost:3002/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart api-tester"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3002/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  omni:
    description: "OMNI — Omni-channel orchestrator (port 3003)"
    healthCheck:
      command: "curl -sf http://localhost:3003/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart omni"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3003/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  iib-esb:
    description: "IIB ESB — Integration Bus (port 3004)"
    healthCheck:
      command: "curl -sf http://localhost:3004/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart iib-esb"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3004/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  wms:
    description: "WMS — Warehouse Management System (port 3005)"
    healthCheck:
      command: "curl -sf http://localhost:3005/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart wms"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3005/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  sap-s4:
    description: "SAP S/4HANA — Sales order processing (port 3006)"
    healthCheck:
      command: "curl -sf http://localhost:3006/sap/bc/ping"
      timeoutMs: 5000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart sap-s4"
        timeoutMs: 20000
      - command: "sleep 3"
        timeoutMs: 5000
        required: false
    verify:
      command: "curl -sf http://localhost:3006/sap/bc/ping"
      timeoutMs: 5000
    maxRetries: 2
    backoffMs: [3000, 6000]

  message-broker:
    description: "Message Broker — In-memory pub/sub with DLQ (port 3008)"
    healthCheck:
      command: "curl -sf http://localhost:3008/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart message-broker"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3008/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]

  kibana:
    description: "Kibana — Analytics dashboard (port 3007)"
    healthCheck:
      command: "curl -sf http://localhost:3007/health"
      timeoutMs: 3000
    recover:
      - command: "docker compose -f v3/demo/adidas-order-to-cash/docker-compose.yml restart kibana"
        timeoutMs: 15000
    verify:
      command: "curl -sf http://localhost:3007/health"
      timeoutMs: 3000
    maxRetries: 2
    backoffMs: [2000, 5000]
