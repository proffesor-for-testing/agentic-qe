services:
  ruvector:
    image: ruvnet/ruvector:latest
    container_name: agentic-qe-ruvector
    restart: unless-stopped

    ports:
      - "8080:8080"  # REST API
      - "9090:9090"  # gRPC

    environment:
      # Core Configuration
      RUVECTOR_LEARNING_ENABLED: "true"
      RUVECTOR_EMBEDDING_DIM: "768"

      # HNSW Index Configuration
      RUVECTOR_HNSW_M: "32"                    # Number of bi-directional links per node
      RUVECTOR_HNSW_EF_CONSTRUCTION: "200"     # Size of dynamic candidate list during construction
      RUVECTOR_HNSW_EF_SEARCH: "100"          # Size of dynamic candidate list during search

      # Self-Learning Configuration
      RUVECTOR_LORA_RANK: "8"                  # LoRA rank for efficient fine-tuning
      RUVECTOR_LORA_ALPHA: "16"                # LoRA scaling factor
      RUVECTOR_EWC_ENABLED: "true"             # Elastic Weight Consolidation for catastrophic forgetting prevention
      RUVECTOR_EWC_LAMBDA: "0.4"               # EWC regularization strength

      # Memory Management
      RUVECTOR_MAX_MEMORY_GB: "4"              # Maximum memory usage
      RUVECTOR_CACHE_SIZE_MB: "512"            # Cache size for embeddings

      # Logging
      RUVECTOR_LOG_LEVEL: "info"
      RUVECTOR_LOG_FORMAT: "json"

    volumes:
      # Persistent data storage
      - ruvector-data:/data
      - ruvector-models:/models

      # Optional: Mount local config
      # - ./config/ruvector.yml:/app/config.yml:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    networks:
      - agentic-qe-network

    # Development profile overrides
    profiles:
      - production

  # Development configuration with debug settings
  ruvector-dev:
    extends:
      service: ruvector
    container_name: agentic-qe-ruvector-dev

    environment:
      # Override with development settings
      RUVECTOR_LOG_LEVEL: "debug"
      RUVECTOR_LOG_FORMAT: "text"
      RUVECTOR_DEBUG_ENABLED: "true"
      RUVECTOR_PROFILING_ENABLED: "true"

      # More aggressive learning for development
      RUVECTOR_LORA_RANK: "16"
      RUVECTOR_EWC_LAMBDA: "0.3"

    ports:
      - "8080:8080"
      - "9090:9090"
      - "6060:6060"  # Profiling endpoint

    volumes:
      - ruvector-data-dev:/data
      - ruvector-models-dev:/models

      # Mount local code for development (if available)
      # - ../ruvector:/app:ro

    profiles:
      - development

volumes:
  # Production volumes
  ruvector-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${RUVECTOR_DATA_PATH:-./data/ruvector}

  ruvector-models:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${RUVECTOR_MODELS_PATH:-./data/ruvector-models}

  # Development volumes
  ruvector-data-dev:
    driver: local

  ruvector-models-dev:
    driver: local

networks:
  agentic-qe-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
