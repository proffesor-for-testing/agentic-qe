# HybridRouter RuVector Architecture

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        HybridRouter                              │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Request Flow (Cache-First)                 │    │
│  │                                                          │    │
│  │  1. Analyze Complexity & Privacy                        │    │
│  │        │                                                 │    │
│  │        ├─ Privacy-sensitive? ──> Skip Cache ──> Local   │    │
│  │        │                                                 │    │
│  │        └─ Safe to cache?                                │    │
│  │              │                                           │    │
│  │              v                                           │    │
│  │  2. Try RuVector Cache (sub-ms)                         │    │
│  │        │                                                 │    │
│  │        ├─ Cache Hit (confidence ≥ 0.85)                 │    │
│  │        │     │                                           │    │
│  │        │     └──> Return Cached Response (2-5ms) ✅     │    │
│  │        │                                                 │    │
│  │        └─ Cache Miss                                    │    │
│  │              │                                           │    │
│  │              v                                           │    │
│  │  3. Route to LLM (Intelligent Routing)                  │    │
│  │        │                                                 │    │
│  │        ├─ Simple/Moderate ──> Local (ruvLLM)           │    │
│  │        ├─ Complex ──────────> Cloud (Claude)           │    │
│  │        └─ Very Complex ──────> Cloud (Claude)          │    │
│  │              │                                           │    │
│  │              v                                           │    │
│  │  4. Store Response for Learning (async, non-blocking)   │    │
│  │        │                                                 │    │
│  │        └──> RuVector ──> LoRA Update ──> Future Hits   │    │
│  │                                                          │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Component Integration

```
┌──────────────────────────────────────────────────────────────────────┐
│                           User Application                           │
└────────────────────────────┬─────────────────────────────────────────┘
                             │
                             │ complete(options)
                             v
┌──────────────────────────────────────────────────────────────────────┐
│                          HybridRouter                                 │
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │  RuVectorClient │  │  RuvllmProvider │  │  ClaudeProvider │     │
│  │   (Cache Layer) │  │   (Local LLM)   │  │   (Cloud LLM)   │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
└───────────┼────────────────────┼────────────────────┼───────────────┘
            │                    │                    │
            │ HTTP               │ HTTP               │ HTTP
            │ :8080              │ :11434             │ api.anthropic.com
            v                    v                    v
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  RuVector Docker │  │  ruvLLM Service  │  │  Claude API      │
│                  │  │                  │  │                  │
│  - Vector Store  │  │  - Local Model   │  │  - Cloud Model   │
│  - GNN Reranking │  │  - Embeddings    │  │  - Streaming     │
│  - LoRA Learning │  │  - TRM Support   │  │  - Vision        │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

## Request Flow Sequence Diagram

```
User App    HybridRouter    RuVector    ruvLLM    Claude
   │             │              │          │         │
   │  complete() │              │          │         │
   ├────────────>│              │          │         │
   │             │              │          │         │
   │             │ 1. Generate  │          │         │
   │             │    Embedding │          │         │
   │             ├─────────────────────────>│        │
   │             │<─────────────────────────┤        │
   │             │    embedding[]           │        │
   │             │              │          │         │
   │             │ 2. Search    │          │         │
   │             │    Cache     │          │         │
   │             ├─────────────>│          │         │
   │             │<─────────────┤          │         │
   │             │   results[]  │          │         │
   │             │              │          │         │
   │             │ 3a. If Hit (confidence ≥ 0.85)   │
   │<────────────┤              │          │         │
   │  response   │  return cached          │         │
   │             │              │          │         │
   │             │ 3b. If Miss  │          │         │
   │             │ (confidence < 0.85)     │         │
   │             │              │          │         │
   │             │ 4. Route by  │          │         │
   │             │    Complexity│          │         │
   │             │              │          │         │
   │             │ Simple/Moderate         │         │
   │             ├─────────────────────────>│        │
   │             │<─────────────────────────┤        │
   │             │    LLM response          │        │
   │             │              │          │         │
   │             │ Complex/Very Complex    │         │
   │             ├────────────────────────────────────>│
   │             │<────────────────────────────────────┤
   │             │         LLM response                │
   │             │              │          │         │
   │             │ 5. Store for │          │         │
   │             │    Learning  │          │         │
   │             ├─────────────>│          │         │
   │             │ (async)      │          │         │
   │             │              │ LoRA     │         │
   │             │              │ Update   │         │
   │             │              │          │         │
   │<────────────┤              │          │         │
   │  response   │              │          │         │
   │             │              │          │         │
```

## Cache Hit Decision Tree

```
                        ┌─────────────────┐
                        │ Request Arrives │
                        └────────┬────────┘
                                 │
                    ┌────────────▼────────────┐
                    │ Privacy-Sensitive Data? │
                    └──┬──────────────────┬───┘
                       │ YES              │ NO
                       │                  │
              ┌────────▼────────┐         │
              │ Skip Cache      │         │
              │ Route to Local  │         │
              └─────────────────┘         │
                                          │
                             ┌────────────▼─────────────┐
                             │ skipCacheForComplexTasks │
                             │ AND complexity=COMPLEX?  │
                             └──┬───────────────────┬───┘
                                │ YES               │ NO
                                │                   │
                       ┌────────▼────────┐          │
                       │ Skip Cache      │          │
                       │ Route by Rule   │          │
                       └─────────────────┘          │
                                                    │
                                       ┌────────────▼────────────┐
                                       │ Query RuVector Cache    │
                                       └──┬──────────────────┬───┘
                                          │ confidence ≥ 0.85│ confidence < 0.85
                                          │                  │
                                 ┌────────▼────────┐  ┌──────▼──────┐
                                 │ Cache Hit! ✅   │  │ Cache Miss  │
                                 │ Return (2-5ms)  │  │ Route to LLM│
                                 └─────────────────┘  └──────┬──────┘
                                                             │
                                                    ┌────────▼────────┐
                                                    │ Store Result    │
                                                    │ for Learning    │
                                                    └─────────────────┘
```

## Data Flow for Learning

```
┌────────────────────────────────────────────────────────────────┐
│                  Learning Cycle (LoRA)                         │
│                                                                 │
│  1. Cache Miss                                                 │
│     └─> Query: "How to test async functions?"                 │
│                                                                 │
│  2. LLM Response (Cloud or Local)                             │
│     └─> Response: "Use jest.fn() and async/await..."         │
│                                                                 │
│  3. Generate Embedding                                        │
│     └─> embedding: [0.234, -0.456, 0.789, ...]               │
│                                                                 │
│  4. Store Pattern                                             │
│     ┌────────────────────────────────────────┐                │
│     │ POST /v1/store                         │                │
│     │ {                                      │                │
│     │   embedding: [...],                    │                │
│     │   content: "Use jest.fn()...",         │                │
│     │   metadata: {                          │                │
│     │     query: "How to test async...",     │                │
│     │     model: "claude-sonnet-4",          │                │
│     │     complexity: "moderate",            │                │
│     │     timestamp: "2025-12-19T..."        │                │
│     │   },                                   │                │
│     │   learningConfig: {                    │                │
│     │     loraRank: 8,                       │                │
│     │     ewcLambda: 0.5,                    │                │
│     │     triggerConsolidation: true         │                │
│     │   }                                    │                │
│     │ }                                      │                │
│     └────────────────────────────────────────┘                │
│                         │                                      │
│                         v                                      │
│  5. LoRA Update (RuVector Docker)                             │
│     - Update 8-rank adapter weights                           │
│     - Apply EWC (λ=0.5) to prevent forgetting                │
│     - Store in vector database                                │
│                         │                                      │
│                         v                                      │
│  6. Future Query: "How to test async code?"                  │
│     └─> Similar embedding ──> Cache Hit! ✅                  │
│         (confidence: 0.92 > threshold: 0.85)                  │
│         └─> Sub-ms response                                   │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

## Performance Characteristics

```
┌──────────────────────────────────────────────────────────────┐
│                    Latency Comparison                         │
│                                                               │
│  Cache Hit (RuVector):     █ 2-5ms                           │
│  Local LLM (ruvLLM):       ████████████████ 1000-3000ms      │
│  Cloud LLM (Claude):       ████████████ 800-2000ms           │
│                                                               │
│  Cost Comparison (per request):                              │
│                                                               │
│  Cache Hit:    $0.000    ████████████████████████ FREE       │
│  Local LLM:    $0.000    ████████████████████████ FREE       │
│  Cloud LLM:    $0.010    █ Paid                              │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

## Cache Hit Rate Impact

```
┌───────────────────────────────────────────────────────────────┐
│              Cost Savings by Hit Rate                         │
│                                                                │
│  100 Requests/Day, $0.01/Request Cloud Cost                   │
│                                                                │
│  Hit Rate    Cache Hits    Cloud Calls    Daily Cost   Savings│
│  ───────────────────────────────────────────────────────────  │
│    0%            0            100          $1.00        $0.00 │
│   20%           20             80          $0.80        $0.20 │
│   40%           40             60          $0.60        $0.40 │
│   60%           60             40          $0.40        $0.60 │
│   80%           80             20          $0.20        $0.80 │
│   90%           90             10          $0.10        $0.90 │
│   95%           95              5          $0.05        $0.95 │
│                                                                │
│  At 60% hit rate: Save $219/year per 100 daily requests!     │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

## Metrics Dashboard View

```
┌──────────────────────────────────────────────────────────────┐
│              HybridRouter + RuVector Metrics                  │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  Total Requests:        1,234                                │
│  Cache Hits:              741  (60.0%)                       │
│  Cache Misses:            493  (40.0%)                       │
│  Local Routes:            298  (24.1%)                       │
│  Cloud Routes:            195  (15.8%)                       │
│                                                               │
│  Cache Hit Rate:        60.0%  ████████████░░░░░░░░░░       │
│                                                               │
│  RuVector Status:       Healthy ✅                           │
│    - Vector Count:      1,000                                │
│    - GNN Status:        Active                               │
│    - LoRA Updates:      87                                   │
│    - Memory Usage:      256 MB                               │
│                                                               │
│  Cost Analysis:                                              │
│    - Total Cost:        $1.95                                │
│    - Est. Cloud Cost:   $12.34                               │
│    - Savings:           $10.39  (84.2%)                      │
│    - Cache Savings:     $7.41   (71.3%)                      │
│                                                               │
│  Performance:                                                │
│    - Avg Cache Latency:   3.2 ms                            │
│    - Avg Local Latency:   2,134 ms                          │
│    - Avg Cloud Latency:   987 ms                            │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

## Configuration Matrix

```
┌────────────────────────────────────────────────────────────────────┐
│                  Configuration Scenarios                           │
├─────────────────┬──────────────┬──────────────┬──────────────────┤
│   Scenario      │  Threshold   │  Skip Complex│  Privacy First   │
├─────────────────┼──────────────┼──────────────┼──────────────────┤
│ Cost Optimized  │    0.80      │    false     │      false       │
│ (Maximize Hits) │              │              │                  │
├─────────────────┼──────────────┼──────────────┼──────────────────┤
│ Quality Focus   │    0.90      │    true      │      false       │
│ (High Accuracy) │              │              │                  │
├─────────────────┼──────────────┼──────────────┼──────────────────┤
│ Privacy First   │    0.85      │    false     │      true        │
│ (Never Cloud)   │              │              │                  │
├─────────────────┼──────────────┼──────────────┼──────────────────┤
│ Balanced        │    0.85      │    false     │      false       │
│ (Recommended)   │              │              │                  │
└─────────────────┴──────────────┴──────────────┴──────────────────┘
```

---

**Architecture Status:** Production-Ready
**Last Updated:** 2025-12-19
**Version:** M0.5.3
