{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agentic-qe.dev/schemas/pentest-validation-output.json",
  "title": "AQE Pentest Validation Skill Output Schema",
  "description": "Schema for pentest-validation skill output validation. Validates graduated exploitation results, finding classifications, PoC evidence, and 'No Exploit, No Report' filtering.",
  "type": "object",
  "required": ["skillName", "version", "timestamp", "status", "trustTier", "output"],
  "properties": {
    "skillName": {
      "type": "string",
      "const": "pentest-validation",
      "description": "Must be 'pentest-validation'"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+)?$",
      "description": "Semantic version of the skill"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of output generation"
    },
    "status": {
      "type": "string",
      "enum": ["success", "partial", "failed", "blocked", "awaiting-authorization"],
      "description": "Overall execution status"
    },
    "trustTier": {
      "type": "integer",
      "const": 3,
      "description": "Trust tier 3 indicates full validation with eval suite"
    },
    "output": {
      "type": "object",
      "required": ["validationSummary", "findings"],
      "properties": {
        "validationSummary": {
          "$ref": "#/$defs/validationSummary",
          "description": "Summary of validation results"
        },
        "findings": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/validatedFinding"
          },
          "description": "Validated findings (only confirmed/likely per 'No Exploit, No Report')"
        },
        "eliminatedFindings": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/eliminatedFinding"
          },
          "description": "Findings eliminated as false positives"
        },
        "inconclusiveFindings": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/inconclusiveFinding"
          },
          "description": "Findings requiring manual review"
        },
        "costBreakdown": {
          "$ref": "#/$defs/costBreakdown",
          "description": "Cost per pipeline and total"
        },
        "playbookUpdates": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of new patterns stored in exploit playbook"
        }
      }
    }
  },
  "$defs": {
    "validationSummary": {
      "type": "object",
      "required": ["findingsReceived", "confirmedExploitable", "notExploitable"],
      "properties": {
        "findingsReceived": {
          "type": "integer",
          "minimum": 0,
          "description": "Total findings received from scanner"
        },
        "confirmedExploitable": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings proven exploitable with PoC"
        },
        "likelyExploitable": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings with partial exploitation evidence"
        },
        "notExploitable": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings confirmed as false positives"
        },
        "inconclusive": {
          "type": "integer",
          "minimum": 0,
          "description": "Findings blocked by defenses (need manual review)"
        },
        "falsePositivesEliminated": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of false positives removed from report"
        },
        "exploitationTierUsed": {
          "type": "integer",
          "enum": [1, 2, 3],
          "description": "Highest exploitation tier used in this run"
        }
      }
    },
    "validatedFinding": {
      "type": "object",
      "required": ["id", "type", "severity", "classification", "evidence"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Finding identifier"
        },
        "type": {
          "type": "string",
          "enum": [
            "sql-injection", "nosql-injection", "command-injection", "ldap-injection",
            "reflected-xss", "stored-xss", "dom-xss",
            "auth-bypass", "session-fixation", "jwt-manipulation", "idor", "credential-stuffing",
            "ssrf", "dns-rebinding", "protocol-smuggling",
            "path-traversal", "ssti", "deserialization", "hardcoded-credentials",
            "other"
          ],
          "description": "Vulnerability type"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "info"],
          "description": "Severity classification"
        },
        "classification": {
          "type": "string",
          "enum": ["confirmed-exploitable", "likely-exploitable"],
          "description": "Exploitation status (only confirmed/likely in output)"
        },
        "location": {
          "type": "string",
          "description": "Source code location (file:line)"
        },
        "exploitTier": {
          "type": "integer",
          "enum": [1, 2, 3],
          "description": "Exploitation tier used to confirm"
        },
        "evidence": {
          "$ref": "#/$defs/exploitEvidence",
          "description": "Exploitation evidence"
        },
        "poc": {
          "type": "string",
          "minLength": 10,
          "description": "Copy-paste proof-of-concept command"
        },
        "remediation": {
          "type": "string",
          "minLength": 20,
          "description": "Recommended fix with code example"
        },
        "cwe": {
          "type": "string",
          "pattern": "^CWE-\\d+$",
          "description": "CWE identifier"
        },
        "owasp": {
          "type": "string",
          "pattern": "^A\\d{2}:\\d{4}$",
          "description": "OWASP Top 10 category"
        }
      }
    },
    "exploitEvidence": {
      "type": "object",
      "required": ["proof"],
      "properties": {
        "payload": {
          "type": "string",
          "description": "Payload used for exploitation"
        },
        "response": {
          "type": "string",
          "description": "Server response demonstrating exploitation"
        },
        "proof": {
          "type": "string",
          "minLength": 10,
          "description": "Human-readable description of what was proven"
        },
        "screenshots": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Screenshot paths (for browser-based exploits)"
        }
      }
    },
    "eliminatedFinding": {
      "type": "object",
      "required": ["id", "type", "reason"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Finding identifier"
        },
        "type": {
          "type": "string",
          "description": "Vulnerability type"
        },
        "reason": {
          "type": "string",
          "minLength": 10,
          "description": "Why this finding was classified as not-exploitable"
        }
      }
    },
    "inconclusiveFinding": {
      "type": "object",
      "required": ["id", "type", "reason"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Finding identifier"
        },
        "type": {
          "type": "string",
          "description": "Vulnerability type"
        },
        "reason": {
          "type": "string",
          "description": "Why this finding could not be conclusively validated"
        },
        "manualSteps": {
          "type": "string",
          "description": "Suggested manual validation steps"
        }
      }
    },
    "costBreakdown": {
      "type": "object",
      "properties": {
        "totalUsd": {
          "type": "number",
          "minimum": 0,
          "description": "Total cost in USD"
        },
        "tier1Cost": {
          "type": "number",
          "minimum": 0,
          "description": "Tier 1 (Agent Booster) cost - always $0"
        },
        "tier2Cost": {
          "type": "number",
          "minimum": 0,
          "description": "Tier 2 (Haiku) cost"
        },
        "tier3Cost": {
          "type": "number",
          "minimum": 0,
          "description": "Tier 3 (Sonnet/Opus) cost"
        },
        "budgetRemaining": {
          "type": "number",
          "description": "Remaining budget after validation"
        },
        "withinBudget": {
          "type": "boolean",
          "description": "Whether validation stayed within budget cap"
        }
      }
    }
  }
}
