import { Page, Locator, expect } from '@playwright/test';
import { BasePage } from './BasePage';

/**
 * Home Page Object for Sauce Demo Shopify Store
 *
 * QE Assessment: sauce-demo.myshopify.com
 * Generated by: QE Queen Coordinator - qe-test-architect domain
 */
export class HomePage extends BasePage {
  // Hero section
  readonly heroSection: Locator;
  readonly heroCTA: Locator;

  // Featured products section
  readonly featuredSection: Locator;
  readonly productCards: Locator;
  readonly productTitles: Locator;
  readonly productPrices: Locator;
  readonly productImages: Locator;

  // Featured products on home page
  readonly greyJacket: Locator;
  readonly noirJacket: Locator;
  readonly stripedTop: Locator;

  // Collection links
  readonly viewAllLink: Locator;
  readonly collectionLinks: Locator;

  constructor(page: Page) {
    super(page);

    // Hero section selectors (Shopify Simple theme)
    this.heroSection = page.locator('.hero, .slideshow, .image-with-text, [class*="hero"]');
    this.heroCTA = page.locator('.hero__btn, .btn--hero, .hero a.btn');

    // Featured products selectors
    this.featuredSection = page.locator(
      '.featured-collection, .collection-products, #shopify-section-featured-collection, [class*="featured"]'
    );
    this.productCards = page.locator(
      '.product-card, .grid-product, .product-item, [class*="product-card"]'
    );
    this.productTitles = page.locator(
      '.product-card__title, .grid-product__title, .product-item__title, [class*="product"] [class*="title"]'
    );
    this.productPrices = page.locator(
      '.product-card__price, .grid-product__price, .product-item__price, [class*="product"] [class*="price"]'
    );
    this.productImages = page.locator(
      '.product-card__image, .grid-product__image, .product-item img'
    );

    // Specific products (by title text)
    this.greyJacket = page.locator('[class*="product"]:has-text("Grey jacket")').first();
    this.noirJacket = page.locator('[class*="product"]:has-text("Noir jacket")').first();
    this.stripedTop = page.locator('[class*="product"]:has-text("Striped top")').first();

    // Collection navigation
    this.viewAllLink = page.locator('a:has-text("View all"), a:has-text("Shop all"), .collection__view-all');
    this.collectionLinks = page.locator('a[href*="/collections/"]');
  }

  /**
   * Navigate to home page
   */
  async goto(): Promise<void> {
    await super.goto('/');
    await this.waitForShopifyReady();
  }

  /**
   * Get count of featured products displayed
   */
  async getFeaturedProductCount(): Promise<number> {
    return await this.productCards.count();
  }

  /**
   * Get all product titles displayed on home page
   */
  async getProductTitles(): Promise<string[]> {
    const titles = await this.productTitles.allTextContents();
    return titles.map(t => t.trim());
  }

  /**
   * Get all product prices displayed
   */
  async getProductPrices(): Promise<string[]> {
    const prices = await this.productPrices.allTextContents();
    return prices.map(p => p.trim());
  }

  /**
   * Click on a product by its name
   */
  async clickProduct(productName: string): Promise<void> {
    const productCard = this.page.locator(`[class*="product"]:has-text("${productName}")`).first();
    await productCard.click();
    await this.page.waitForURL('**/products/**');
  }

  /**
   * Click on first product in the grid
   */
  async clickFirstProduct(): Promise<void> {
    await this.productCards.first().click();
    await this.page.waitForURL('**/products/**');
  }

  /**
   * Navigate to view all products
   */
  async viewAllProducts(): Promise<void> {
    await this.viewAllLink.first().click();
    await this.page.waitForURL('**/collections/**');
  }

  /**
   * Assert home page loaded correctly
   */
  async assertHomePageLoaded(): Promise<void> {
    await this.assertPageLoaded();
    await expect(this.page).toHaveURL(/.*sauce-demo\.myshopify\.com\/?$/);
    // Verify at least some products are displayed
    await expect(this.productCards.first()).toBeVisible({ timeout: 10000 });
  }

  /**
   * Assert featured products are displayed
   */
  async assertFeaturedProductsVisible(): Promise<void> {
    const count = await this.getFeaturedProductCount();
    expect(count).toBeGreaterThan(0);

    // Verify product images load
    const firstImage = this.productImages.first();
    await expect(firstImage).toBeVisible();
  }
}
