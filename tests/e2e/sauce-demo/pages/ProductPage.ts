import { Page, Locator, expect } from '@playwright/test';
import { BasePage } from './BasePage';

/**
 * Product Detail Page Object for Sauce Demo Shopify Store
 *
 * QE Assessment: sauce-demo.myshopify.com
 * Generated by: QE Queen Coordinator - qe-test-architect domain
 */
export class ProductPage extends BasePage {
  // Product information
  readonly productTitle: Locator;
  readonly productPrice: Locator;
  readonly productDescription: Locator;
  readonly productVendor: Locator;
  readonly productSKU: Locator;

  // Product images
  readonly mainImage: Locator;
  readonly thumbnailImages: Locator;
  readonly imageGallery: Locator;

  // Variant selectors
  readonly variantSelectors: Locator;
  readonly sizeSelector: Locator;
  readonly colorSelector: Locator;

  // Quantity controls
  readonly quantityInput: Locator;
  readonly quantityDecrease: Locator;
  readonly quantityIncrease: Locator;

  // Add to cart
  readonly addToCartButton: Locator;
  readonly buyNowButton: Locator;

  // Product details
  readonly productDetails: Locator;
  readonly accordion: Locator;

  // Notifications
  readonly addedToCartNotification: Locator;
  readonly errorMessage: Locator;

  // Related products
  readonly relatedProducts: Locator;

  constructor(page: Page) {
    super(page);

    // Product information selectors (Shopify Simple theme)
    this.productTitle = page.locator(
      '.product-single__title, .product__title, h1[class*="product"]'
    ).first();
    this.productPrice = page.locator(
      '.product-single__price, .product__price, [class*="product-price"], [data-product-price]'
    ).first();
    this.productDescription = page.locator(
      '.product-single__description, .product__description, [class*="product-description"]'
    );
    this.productVendor = page.locator('.product-single__vendor, .product__vendor');
    this.productSKU = page.locator('.product-single__sku, [data-product-sku]');

    // Image selectors
    this.mainImage = page.locator(
      '.product-single__photo, .product__image, .product-featured-image, [class*="product"] img'
    ).first();
    this.thumbnailImages = page.locator('.product-single__thumbnails img, .product__thumbs img');
    this.imageGallery = page.locator('.product__photos, .product-gallery, .product-images');

    // Variant selectors
    this.variantSelectors = page.locator(
      '.product-form__variants, [data-variant-options], .variant-wrapper'
    );
    this.sizeSelector = page.locator(
      'select[name*="Size"], [data-option-name="Size"], label:has-text("Size") + select'
    );
    this.colorSelector = page.locator(
      'select[name*="Color"], [data-option-name="Color"], label:has-text("Color") + select'
    );

    // Quantity selectors
    this.quantityInput = page.locator(
      'input[name="quantity"], .quantity-selector input, [data-quantity-input]'
    );
    this.quantityDecrease = page.locator(
      '.quantity-selector button:first-child, [data-quantity-minus], button:has-text("-")'
    );
    this.quantityIncrease = page.locator(
      '.quantity-selector button:last-child, [data-quantity-plus], button:has-text("+")'
    );

    // Add to cart selectors
    this.addToCartButton = page.locator(
      'button[name="add"], [data-add-to-cart], .product-form__cart-submit, button:has-text("Add to cart")'
    ).first();
    this.buyNowButton = page.locator(
      '.shopify-payment-button button, [data-shopify-buy-now], button:has-text("Buy it now")'
    );

    // Details and accordion
    this.productDetails = page.locator('.product__details, .product-details');
    this.accordion = page.locator('.product__accordion, .accordion');

    // Notifications
    this.addedToCartNotification = page.locator(
      '.cart-notification, [data-cart-notification], .ajax-cart__success'
    );
    this.errorMessage = page.locator('.product-form__error, [data-product-error], .errors');

    // Related products
    this.relatedProducts = page.locator(
      '.related-products, .product-recommendations, [data-product-recommendations]'
    );
  }

  /**
   * Navigate to a specific product page
   */
  async goto(productHandle: string): Promise<void> {
    await super.goto(`/products/${productHandle}`);
    await this.waitForShopifyReady();
  }

  /**
   * Get product title text
   */
  async getTitle(): Promise<string> {
    return (await this.productTitle.textContent() || '').trim();
  }

  /**
   * Get product price
   */
  async getPrice(): Promise<string> {
    return (await this.productPrice.textContent() || '').trim();
  }

  /**
   * Get product description
   */
  async getDescription(): Promise<string> {
    return (await this.productDescription.textContent() || '').trim();
  }

  /**
   * Select a product variant by option name and value
   */
  async selectVariant(optionName: string, value: string): Promise<void> {
    const selector = this.page.locator(
      `select[name*="${optionName}"], [data-option-name="${optionName}"] select`
    );
    if (await selector.isVisible()) {
      await selector.selectOption({ label: value });
    } else {
      // Handle swatch-style variant selectors
      const swatch = this.page.locator(`[data-value="${value}"], label:has-text("${value}")`);
      await swatch.click();
    }
  }

  /**
   * Set product quantity
   */
  async setQuantity(quantity: number): Promise<void> {
    await this.quantityInput.fill(quantity.toString());
  }

  /**
   * Increase quantity by clicking + button
   */
  async increaseQuantity(times: number = 1): Promise<void> {
    for (let i = 0; i < times; i++) {
      await this.quantityIncrease.click();
    }
  }

  /**
   * Add current product to cart
   */
  async addToCart(): Promise<void> {
    await this.addToCartButton.click();

    // Wait for either notification or cart count update
    await Promise.race([
      this.addedToCartNotification.waitFor({ state: 'visible', timeout: 5000 }).catch(() => {}),
      this.page.waitForResponse(resp => resp.url().includes('/cart/add'), { timeout: 5000 }).catch(() => {}),
    ]);

    // Small delay for cart count to update
    await this.page.waitForTimeout(500);
  }

  /**
   * Click buy now button (proceeds to checkout)
   */
  async buyNow(): Promise<void> {
    await this.buyNowButton.click();
    await this.page.waitForURL('**/checkouts/**', { timeout: 15000 });
  }

  /**
   * Click on a thumbnail image
   */
  async clickThumbnail(index: number): Promise<void> {
    await this.thumbnailImages.nth(index).click();
  }

  /**
   * Assert product page loaded correctly
   */
  async assertProductPageLoaded(): Promise<void> {
    await this.assertPageLoaded();
    await expect(this.page).toHaveURL(/.*\/products\/.*/);
    await expect(this.productTitle).toBeVisible();
    await expect(this.productPrice).toBeVisible();
    await expect(this.addToCartButton).toBeVisible();
  }

  /**
   * Assert add to cart was successful
   */
  async assertAddedToCart(): Promise<void> {
    // Verify cart count increased or notification appeared
    const cartCountVisible = await this.cartCount.isVisible();
    if (cartCountVisible) {
      const count = await this.getCartCount();
      expect(count).toBeGreaterThan(0);
    }
  }

  /**
   * Assert product images are loading
   */
  async assertImagesLoaded(): Promise<void> {
    await expect(this.mainImage).toBeVisible();

    // Verify image has valid src
    const src = await this.mainImage.getAttribute('src');
    expect(src).toBeTruthy();
    expect(src).toMatch(/\.(jpg|jpeg|png|webp|gif)/i);
  }
}
