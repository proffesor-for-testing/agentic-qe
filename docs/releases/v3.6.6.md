# v3.6.6 Release Notes

**Release Date:** 2026-02-13

## Highlights

Fixes `aqe` crash on Node 22+ (`ERR_MODULE_NOT_FOUND: better-sqlite3`), restores self-learning hooks pipeline that was broken for 8+ days, and ensures all CLI commands write to a single project root database.

## Fixed

- **Node 22+ crash on global install** — `aqe --version` failed with `ERR_MODULE_NOT_FOUND` because Node 22's ESM resolver cannot handle native packages without an `exports` field. Build now uses `createRequire()` shims for all native modules.
- **Hooks writing to wrong database** — Self-learning hooks could create a duplicate `.agentic-qe/` database in subdirectories. All hooks and learning commands now use `findProjectRoot()` to always resolve to the project root.
- **Silent hook failures** — Removed 12 dead hooks (`npx @claude-flow/cli@latest` and `v3-qe-bridge.sh`) that silently failed on every tool use. Each hook event now has one working handler.
- **Vector dimension mismatch in hooks** — HNSW index initialized at 128-dim while DB vectors were 768-dim, causing in-memory fallback. All embedding dimension defaults fixed to 768.
- **Learning experiences not tracked** — `post-task` hook's `recordOutcome` only fired when `--agent` was explicitly passed. Relaxed to always fire when `--task-id` is present.
- **FK constraint blocking analytics** — Removed foreign key on `qe_pattern_usage` that rejected synthetic pattern IDs from hooks.
- **Statusline missing hook data** — Experience count now includes `qe_pattern_usage` entries.

## Changed

- **Build system modernized** — `build-cli.js` and `build-mcp.js` use esbuild's JavaScript API with `nativeRequirePlugin` for Node 22+ compatibility. `chalk` externalized to avoid CJS/ESM conflicts.
