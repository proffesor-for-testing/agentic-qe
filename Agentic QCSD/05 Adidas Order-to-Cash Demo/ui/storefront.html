<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adidas Storefront â€” E2E Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f5f5f5; color: #333; }
    header { background: #000; color: #fff; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 24px; font-weight: 700; letter-spacing: 2px; }
    .cart-badge { background: #fff; color: #000; padding: 4px 12px; border-radius: 20px; font-weight: 700; cursor: pointer; }
    main { max-width: 1200px; margin: 0 auto; padding: 32px; }
    .products { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
    .product { background: #fff; border-radius: 8px; padding: 24px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .product-img { width: 100%; height: 180px; background: linear-gradient(135deg, #e8e8e8, #d0d0d0); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 48px; margin-bottom: 16px; }
    .product h3 { margin-bottom: 8px; }
    .product .price { font-size: 20px; font-weight: 700; color: #000; margin-bottom: 16px; }
    .btn { padding: 10px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #000; color: #fff; }
    .btn-primary:hover { background: #333; }
    .btn-primary:disabled { background: #999; cursor: not-allowed; }
    .checkout-panel { background: #fff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
    .checkout-panel.active { display: block; }
    .checkout-panel h2 { margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 14px; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .pipeline { margin-top: 32px; display: none; }
    .pipeline.active { display: block; }
    .pipeline h2 { margin-bottom: 16px; }
    .pipeline-steps { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pipeline-step { padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; background: #e8e8e8; color: #666; transition: all 0.3s; }
    .pipeline-step.active { background: #ffc107; color: #000; }
    .pipeline-step.success { background: #28a745; color: #fff; }
    .pipeline-step.failed { background: #dc3545; color: #fff; }
    .pipeline-arrow { font-size: 18px; color: #999; }
    .confirmation { margin-top: 24px; padding: 24px; background: #d4edda; border-radius: 8px; display: none; }
    .confirmation.active { display: block; }
    .confirmation.failed { background: #f8d7da; }
    .error-output { margin-top: 16px; padding: 16px; background: #2d2d2d; color: #f8d7da; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; display: none; }
    .error-output.active { display: block; }
    .cart-summary { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; display: none; }
    .cart-summary.active { display: block; }
    .cart-summary table { width: 100%; border-collapse: collapse; }
    .cart-summary th, .cart-summary td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    .cart-summary .total { font-weight: 700; font-size: 18px; }
  </style>
</head>
<body>
  <header>
    <h1>ADIDAS</h1>
    <div class="cart-badge" data-testid="cart-badge" onclick="showCart()">Cart: 0</div>
  </header>

  <main>
    <h2 style="margin-bottom: 24px;">Order-to-Cash E2E Demo</h2>

    <div class="products">
      <div class="product">
        <div class="product-img">&#x1F45F;</div>
        <h3>Ultraboost 23</h3>
        <div class="price">&euro;180.00</div>
        <button class="btn btn-primary" data-testid="product-ultraboost" onclick="addToCart('ULTRA-23', 'Ultraboost 23', 180)">Add to Cart</button>
      </div>
      <div class="product">
        <div class="product-img">&#x1F455;</div>
        <h3>Home Jersey 2025</h3>
        <div class="price">&euro;90.00</div>
        <button class="btn btn-primary" data-testid="product-jersey" onclick="addToCart('JERSEY-H', 'Home Jersey 2025', 90)">Add to Cart</button>
      </div>
      <div class="product">
        <div class="product-img">&#x1F45C;</div>
        <h3>Duffle Bag</h3>
        <div class="price">&euro;65.00</div>
        <button class="btn btn-primary" data-testid="product-bag" onclick="addToCart('BAG-DFL', 'Duffle Bag', 65)">Add to Cart</button>
      </div>
    </div>

    <div class="cart-summary" id="cart-summary">
      <h2>Shopping Cart</h2>
      <table>
        <thead><tr><th>Product</th><th>Qty</th><th>Price</th></tr></thead>
        <tbody id="cart-items"></tbody>
        <tfoot><tr><td colspan="2" class="total">Total</td><td class="total" id="cart-total">&euro;0.00</td></tr></tfoot>
      </table>
      <br>
      <button class="btn btn-primary" data-testid="checkout-button" onclick="showCheckout()">Proceed to Checkout</button>
    </div>

    <div class="checkout-panel" id="checkout-panel">
      <h2>Checkout</h2>
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" data-testid="input-name" id="input-name" placeholder="John Doe">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" data-testid="input-email" id="input-email" placeholder="john@example.com">
      </div>
      <div class="form-group">
        <label>Shipping Address</label>
        <input type="text" data-testid="input-address" id="input-address" placeholder="123 Main St, Berlin">
      </div>
      <br>
      <button class="btn btn-primary" data-testid="submit-order" id="submit-order" onclick="placeOrder()">Place Order</button>
    </div>

    <div class="pipeline" id="pipeline">
      <h2>Order Pipeline</h2>
      <div class="pipeline-steps">
        <div class="pipeline-step" id="step-integrator" data-testid="system-status-integrator">Integrator</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-api-tester" data-testid="system-status-api-tester">API Tester</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-omni" data-testid="system-status-omni">OMNI</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-iib" data-testid="system-status-iib">IIB ESB</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-wms" data-testid="system-status-wms">WMS</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-sap" data-testid="system-status-sap">SAP S/4</div>
        <span class="pipeline-arrow">&rarr;</span>
        <div class="pipeline-step" id="step-kibana" data-testid="system-status-kibana">Kibana</div>
      </div>
    </div>

    <div class="confirmation" id="confirmation" data-testid="order-confirmation">
      <h3>Order Confirmed</h3>
      <p>Order ID: <strong data-testid="order-id" id="order-id"></strong></p>
      <p>Status: <span id="order-status"></span></p>
      <p>Systems: <span id="order-systems"></span></p>
    </div>

    <div class="error-output" id="error-output" data-testid="error-output"></div>
  </main>

  <script>
    const cart = [];

    function addToCart(id, name, price) {
      const existing = cart.find(i => i.id === id);
      if (existing) { existing.quantity++; }
      else { cart.push({ id, name, price, quantity: 1 }); }
      updateCartBadge();
      showCart();
    }

    function updateCartBadge() {
      const total = cart.reduce((s, i) => s + i.quantity, 0);
      document.querySelector('[data-testid="cart-badge"]').textContent = `Cart: ${total}`;
    }

    function showCart() {
      const el = document.getElementById('cart-summary');
      el.classList.add('active');
      const tbody = document.getElementById('cart-items');
      tbody.innerHTML = cart.map(i =>
        `<tr><td>${i.name}</td><td>${i.quantity}</td><td>&euro;${(i.price * i.quantity).toFixed(2)}</td></tr>`
      ).join('');
      const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
      document.getElementById('cart-total').textContent = `\u20AC${total.toFixed(2)}`;
    }

    function showCheckout() {
      document.getElementById('checkout-panel').classList.add('active');
    }

    const SYSTEMS = ['integrator', 'api-tester', 'omni', 'iib', 'wms', 'sap', 'kibana'];

    function setStepStatus(system, status) {
      const el = document.getElementById(`step-${system}`);
      if (el) {
        el.className = `pipeline-step ${status}`;
        if (status === 'success') el.classList.add('status-success');
      }
    }

    async function placeOrder() {
      const btn = document.getElementById('submit-order');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      document.getElementById('pipeline').classList.add('active');
      document.getElementById('confirmation').classList.remove('active', 'failed');
      document.getElementById('error-output').classList.remove('active');

      // Reset steps
      SYSTEMS.forEach(s => setStepStatus(s, ''));

      // Step 1: Integrator
      setStepStatus('integrator', 'active');
      await delay(300);
      setStepStatus('integrator', 'success');

      // Step 2: API Tester
      setStepStatus('api-tester', 'active');

      const orderPayload = {
        customer: {
          name: document.getElementById('input-name').value || 'Demo User',
          email: document.getElementById('input-email').value || 'demo@adidas.com',
          address: document.getElementById('input-address').value || 'Berlin, Germany',
        },
        items: cart.map(i => ({ id: i.id, productId: i.id, name: i.name, price: i.price, quantity: i.quantity })),
        totalAmount: cart.reduce((s, i) => s + i.price * i.quantity, 0),
      };

      try {
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderPayload),
        });

        const data = await response.json();

        if (response.ok && data.status === 'COMPLETED') {
          setStepStatus('api-tester', 'success');
          // Animate remaining steps
          const trace = data.systemTrace || [];
          for (const step of trace) {
            const systemMap = { 'iib-esb': 'iib', 'sap-s4': 'sap' };
            const key = systemMap[step.system] || step.system;
            setStepStatus(key, 'active');
            await delay(200);
            setStepStatus(key, step.status === 'success' ? 'success' : 'failed');
          }

          const conf = document.getElementById('confirmation');
          conf.classList.add('active');
          document.getElementById('order-id').textContent = data.orderId || 'N/A';
          document.getElementById('order-status').textContent = data.status;
          document.getElementById('order-systems').textContent = `${data.completedSystems}/${data.totalSystems}`;
        } else {
          setStepStatus('api-tester', data.systemTrace ? 'success' : 'failed');
          // Show which system failed
          if (data.systemTrace) {
            for (const step of data.systemTrace) {
              const systemMap = { 'iib-esb': 'iib', 'sap-s4': 'sap' };
              const key = systemMap[step.system] || step.system;
              setStepStatus(key, step.status === 'success' ? 'success' : 'failed');
            }
          }

          const conf = document.getElementById('confirmation');
          conf.classList.add('active', 'failed');
          conf.querySelector('h3').textContent = 'Order Failed';
          document.getElementById('order-id').textContent = data.orderId || 'N/A';
          document.getElementById('order-status').textContent = data.status || 'FAILED';
          document.getElementById('order-systems').textContent =
            `${data.completedSystems || 0}/${data.totalSystems || 7}`;

          const errEl = document.getElementById('error-output');
          errEl.classList.add('active');
          errEl.textContent = JSON.stringify(data, null, 2);
        }
      } catch (err) {
        setStepStatus('api-tester', 'failed');
        const conf = document.getElementById('confirmation');
        conf.classList.add('active', 'failed');
        conf.querySelector('h3').textContent = 'Order Failed';
        document.getElementById('order-id').textContent = 'N/A';
        document.getElementById('order-status').textContent = 'CONNECTION_ERROR';
        document.getElementById('order-systems').textContent = '1/7';
        const errEl = document.getElementById('error-output');
        errEl.classList.add('active');
        errEl.textContent = `Error: ${err.message}\n\nconnect ECONNREFUSED 127.0.0.1:3002`;
      }

      btn.disabled = false;
      btn.textContent = 'Place Order';
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
  </script>
</body>
</html>
